# Документация по ассемблеру VCPU

## Архитектура процессора

### Регистры
- `R1-R6`: 8-битные регистры общего назначения (значения 0-255)
  - Могут использоваться для хранения:
    - Чисел
    - Координат
    - Временных значений
    - Адресов памяти
  - R4 часто используется как регистр остатка при делении

### Флаги
- `ZF` (flags[0x01]): Флаг нуля, устанавливается после операции CMP
  - 0: Числа равны
  - 1: Числа не равны

### Организация памяти
- 4 банка памяти по 256 байт каждый (всего 1024 байта)
- Каждый банк:
  - Адреса 0-127: Код программы
  - Адреса 128-243: Данные программы
  - Адреса 244-255: Стек (12 байт)
- Переключение между банками:
  - Инструкция BANK
  - При переходах между банками нужно явно указывать BANK перед JMP/JE/JNE

## Система ввода-вывода

### Пиксельный дисплей
- Разрешение: 16x16 пикселей
- Каждый пиксель:
  - Может быть включен/выключен
  - Имеет настраиваемую яркость (0-255)
- Координаты:
  - X: 0-15 (слева направо)
  - Y: 0-15 (сверху вниз)

### Семисегментный дисплей
- 8 разрядов
- Поддерживаемые символы:
  - Цифры: 0-9
  - Специальные символы:
    - Минус (код 10)
    - Подчеркивание (код 11)
    - Пробел (код 12)
    - E/ESC (код 13)
    - d/DEL (код 14)
    - n/ENTER (код 15)
    - Стрелки (коды 16-19)
- Режимы вывода:
  - Одиночный символ: указываем позицию (1-7) и значение
  - Полное число: позиция 0, число дополняется нулями слева

### Клавиатура
- Поддерживаемые клавиши и их коды:
  - Цифры: 0-9 (коды 0-9)
  - ESC: код 13
  - DEL: код 14
  - ENTER: код 15
  - Стрелки:
    - Вверх: код 16
    - Вниз: код 17
    - Вправо: код 18
    - Влево: код 19
- Два режима работы:
  - Активный опрос (GETKEY)
  - Автосохранение в память (SAVKEY)

## Инструкции

### Базовые операции
```asm
NOP           ; Нет операции
SET R1 42     ; R1 = 42
MOV R1 R2     ; R1 = R2
HLT           ; Остановка программы
```

### Арифметика
```asm
ADD R1 R2     ; R1 = R1 + R2
SUB R1 R2     ; R1 = R1 - R2
MUL R1 R2     ; R1 = R1 * R2
DIV R1 R2     ; R1 = R1 / R2, R4 = остаток
```

### Логические операции
```asm
AND R1 R2     ; R1 = R1 & R2
OR R1 R2      ; R1 = R1 | R2
XOR R1 R2     ; R1 = R1 ^ R2
CMP R1 R2     ; Сравнить R1 и R2 (устанавливает ZF)
```

### Работа с памятью
```asm
STOREV 0x80 42    ; MEM[0x80] = 42
STORER 0x80 R1    ; MEM[0x80] = R1
LOADR R1 0x80     ; R1 = MEM[0x80]
PUSH R1           ; Сохранить R1 в стек
POP R1            ; Достать значение из стека в R1
```

### Управление потоком
```asm
JMP LABEL         ; Безусловный переход
JE LABEL          ; Переход если равно (ZF = 0)
JNE LABEL         ; Переход если не равно (ZF = 1)
CALL FUNC         ; Вызов подпрограммы
RET               ; Возврат из подпрограммы
```

### Работа с дисплеем
```asm
SETPX R1 R2 R3    ; Установить пиксель (x,y) с яркостью
CLRPX R1 R2       ; Очистить пиксель (x,y)
DIGIT R1 R2       ; Вывести число на дисплей
BRIGHT R1         ; Установить общую яркость
CLEAR             ; Очистить все дисплеи
```

### Ввод и генерация случайных чисел
```asm
GETKEY R1         ; Получить код нажатой клавиши
SAVKEY 0x80       ; Автосохранение кодов в память
RND R1 15         ; Случайное число 0-15 в R1
```

### Работа с банками памяти
```asm
BANK 0            ; Переключиться на банк 0
BANK 1            ; Переключиться на банк 1
```

## Примеры программ

### 1. Мигающий пиксель
```asm
BANK 0
JMP START

:START
    CLEAR           ; Очистить экран
    SET R1 8        ; X = 8
    SET R2 8        ; Y = 8
    SET R3 255      ; Максимальная яркость

:LOOP
    SETPX R1 R2 R3  ; Включить пиксель
    CLRPX R1 R2     ; Выключить пиксель
    JMP LOOP        ; Повторять бесконечно
```

### 2. Счетчик нажатий
```asm
BANK 0
JMP START

:START
    SET R1 0        ; Позиция на дисплее
    SET R2 0        ; Счетчик
    STOREV 0x80 0   ; Сохраняем счетчик в память
    SAVKEY 0x81     ; Адрес для кодов клавиш

:LOOP
    LOADR R3 0x81   ; Загружаем код клавиши
    SET R4 15       ; Код ENTER
    CMP R3 R4       ; Сравниваем
    JNE SKIP        ; Если не ENTER, пропускаем

    LOADR R2 0x80   ; Загружаем счетчик
    SET R4 1
    ADD R2 R4       ; Увеличиваем
    STORER 0x80 R2  ; Сохраняем обратно
    DIGIT R1 R2     ; Выводим на дисплей

:SKIP
    STOREV 0x81 0   ; Очищаем код клавиши
    JMP LOOP
```

## Советы по программированию

### Организация кода
1. Используйте метки для структурирования кода
2. Разделяйте код на логические секции
3. Используйте комментарии для пояснений
4. Следите за банками памяти при переходах

### Отладка
1. Используйте вывод на сегментный дисплей для отладки
2. Проверяйте значения регистров
3. Следите за стеком при использовании CALL/RET
4. Проверяйте границы массивов и дисплея

### Оптимизация
1. Используйте регистры вместо памяти где возможно
2. Минимизируйте переключения между банками
3. Используйте SAVKEY вместо GETKEY для клавиатуры
4. Храните часто используемые значения в памяти